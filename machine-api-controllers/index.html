<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Machine API Controllers - OpenShift Infrastructure Provider Onboarding Guide</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Machine API Controllers";
    var mkdocs_page_input_path = "machine-api-controllers/index.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> OpenShift Infrastructure Provider Onboarding Guide</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Welcome</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../overview/">Overview</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../preparation/">Preparation</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../information-gathering/">Information Gathering</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../openshift-enhancement/">OpenShift Enhancement</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../rhcos/">RHCOS</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../installer/">Installer</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../cloud-controller-manager/">Cloud Controller Manager</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../container-storage-interface-driver/">Container Storage Interface Driver</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Machine API Controllers</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#components-of-machine-api">Components of Machine API</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#custom-resource-definitions">Custom Resource Definitions</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#machine-api-operator">Machine API Operator</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#controllers-owned-by-the-machine-api-operator">Controllers owned by the Machine API Operator</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#machine-api-webhooks">Machine API Webhooks</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#integrating-with-the-machine-api-operator">Integrating with the Machine API Operator</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#machine-api-crds-and-providerspec">Machine API CRDs and ProviderSpec</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#machine-controllers-and-actuators">Machine Controllers and Actuators</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#machineset-controllers">MachineSet Controllers</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#adding-the-new-controllers-to-the-machine-api-operator">Adding the new controllers to the Machine API operator</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#integrating-with-openshift">Integrating with OpenShift</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#add-machine-api-provider-repo-to-openshift">Add Machine API provider repo to OpenShift</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#configure-basic-repository-integrations">Configure basic repository integrations</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#relation-to-cluster-api">Relation to Cluster API</a>
    </li>
    </ul>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../network-ingress-dns/">Network Ingress and DNS</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../continuous-integration-and-testing/">Continuous Integration</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../component-infrastructure/">Component Infrastructure</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../documentation/">Documentation</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../red-hat-relationship/">Red Hat Relationship</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../release/">Release</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">OpenShift Infrastructure Provider Onboarding Guide</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Machine API Controllers</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="machine-api-controllers">Machine API Controllers</h1>
<p>The Machine API is OpenShift's declarative API for infrastructure provider
compute resources. It is responsible for creating, destroying, and monitoring
the machine instances (virtual machines, bare metal servers, etc.) that are
configured for inclusion. In a standard Installer Provisioned Infrastructure
(IPI) installation, the Machine API will include the instances of the compute
plane, the control plane is not managed by the Machine API. In User Provisioned
Infrastructure (UPI) installations, the Machine API may, or may not, be used
depending on the configuration specified by the user.</p>
<h2 id="components-of-machine-api">Components of Machine API</h2>
<p>There are several operators, controllers, and Custom Resource Definitions which
define the Machine API. It is important to understand how these components interact
before building a new infrastructure provider.</p>
<h3 id="custom-resource-definitions">Custom Resource Definitions</h3>
<p>The primary resources of the Machine API are Machines, MachineSets, and
MachineHealthChecks. For the purposes of implementing a new infrastructure
provider, Machines and MachineSets will be the resources that will require
integration.</p>
<p>Machines represent individual host instances within an infrastructure provider that will
become Nodes in the OpenShift cluster.</p>
<p>MachineSets are scalable collections of Machines. Within each MachineSet is a template
for creating new Machines on the infrastructure.</p>
<p>MachineHealthChecks are resources that are used to designate MachineSets which should
automatically repair unhealthy Machines, and the conditions by which those Machine's
health is determined.</p>
<h3 id="machine-api-operator">Machine API Operator</h3>
<p>The <a href="https://github.com/openshift/machine-api-operator">machine-api-operator</a> (MAO) is the main entry point into the Machine API.
The operator is responsible for deploying the infrastructure-specific Machine controller,
and also runs controllers for MachineSets, and MachineHealthChecks. The MAO also deploys
the validating and mutating webhooks for Machine resources.</p>
<p>For more information about the Machine API Operator, please see the
<a href="https://github.com/openshift/machine-api-operator/blob/master/docs/user/machine-api-operator-overview.md">Machine API Operator Overview</a>, and the
<a href="https://github.com/openshift/machine-api-operator/blob/master/docs/dev/hacking-guide.md">Machine API Hacking Guide</a>.</p>
<h4 id="controllers-owned-by-the-machine-api-operator">Controllers owned by the Machine API Operator</h4>
<ul>
<li>Machine controller - manages Machine resources. It uses an <a href="https://github.com/openshift/machine-api-operator/blob/master/pkg/controller/machine/actuator.go">actuator interface</a>,
  which follows a <a href="https://github.com/openshift/enhancements/blob/master/enhancements/machine-api/machine-instance-lifecycle.md">Machine lifecycle pattern</a>. This interface provides <code>Create</code>,
  <code>Update</code>, <code>Exists</code>, and <code>Delete</code> methods to manage provider specific cloud instances, connected
  storage, and networking settings to make the instance prepared for bootstrapping. Each provider
  is therefore responsible for implementing these methods.</li>
<li>MachineSet controller - manages MachineSet resources and ensures the presence of the expected number
  of replicas and a given provider config for a set of Machines. When increasing the replica count,
  this controller will use information in its ProviderSpec to create new Machines, copying that ProviderSpec
  to the Machine in the process.</li>
<li>MachineHealthCheck controller - manages MachineHealthCheck resources. Ensure Machines being
  targeted by MachineHealthCheck objects are satisfying healthiness criteria or are remediated otherwise.
  For more information about MachineHealthChecks, please see the OpenShift <a href="https://docs.openshift.com/container-platform/latest/machine_management/deploying-machine-health-checks.html">Deploying machine health checks</a>
  documentation.</li>
<li>NodeLink controller - ensure Machines have a nodeRef based on <code>providerID</code> matching. Annotate
  nodes with a label containing the Machine name.</li>
</ul>
<p>Although the Machine API operator owns the lifecycle of all these controllers, it is worth
noting that for new infrastructure providers only the Machine controller will require
code changes.</p>
<h4 id="machine-api-webhooks">Machine API Webhooks</h4>
<p>The Machine API operator deploys mutating and validating webhooks for Machines and MachineSets.
The webhooks allow the Machine API operator to detect invalid manifest declarations, or add
values that are required by OpenShift. By using webhooks the Machine API operator is able
to return warnings and errors to the user before the request is accepted by the Kubernetes API server.
For more information about webhooks in Kubernetes, please see the <a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/">Dynamic Admission Control</a>
documentation.</p>
<p>In general, new infrastructure provider should not need to change the webhook configuration.</p>
<h2 id="integrating-with-the-machine-api-operator">Integrating with the Machine API Operator</h2>
<p>There are several steps involved with integrating a new infrastructure provider into the
Machine API on OpenShift. The largest task will be creating the actuator which will do the
work of creating, deleting, and updating infrastructure resources. Beyond that, there
are some details around aligning the deployed release images, and the infrastrcuture detection
within the MAO.</p>
<h3 id="machine-api-crds-and-providerspec">Machine API CRDs and ProviderSpec</h3>
<p>MachineSets and Machines are the resources that describe the server instances within the
infrastructure provider. Each MachineSet contains a <a href="https://github.com/openshift/api/blob/release-4.10/machine/v1beta1/types_machineset.go#L52">Template</a> field which
declares how new Machines should be created by embedding a <a href="https://github.com/openshift/api/blob/release-4.10/machine/v1beta1/types_machine.go#L163">MachineSpec</a>
object. The MachineSpec contains a field named <a href="https://github.com/openshift/api/blob/release-4.10/machine/v1beta1/types_machine.go#L186">ProviderSpec</a>,
although this resource is not a CRD on its own, it is an embedded API type that
allows each infrastructure provider to have a different set of variables to use when creating
new Machines.</p>
<p>While the MachineSet and Machine objects will not need to change to accomodate new infrastructure
providers, the ProviderSpec will need to be created specifically for each new provider.  For example
here are the ProviderSpecs for Alibaba Cloud and IBM Cloud:</p>
<ul>
<li><a href="https://github.com/openshift/api/blob/master/machine/v1/types_alibabaprovider.go">ProviderSpec defined for Alibaba Cloud</a></li>
<li><a href="https://github.com/openshift/cluster-api-provider-ibmcloud/blob/release-4.10/pkg/apis/ibmcloudprovider/v1beta1/ibmcloudproviderconfig_types.go#L30">ProviderSpec defined for IBM Cloud</a></li>
</ul>
<p>When creating a new ProviderSpec it is natural to begin development with the API type defined
within the repository for the new component (akin to the IBM Cloud example). Before final
release the ProviderSpec API code should be moved to the <a href="https://github.com/openshift/api">openshift/api</a> repository
(similar to the Alibaba Cloud example). All new ProviderSpecs will be at API version <code>v1</code>.
The rationale for adding these types to the API repository is that it makes it easier to
re-vendor those API types into other projects, and it promotes a more thorough API review
process. Keep in mind that when adding changes to the API repository, all dependent
repositories (for example installer) will need to be re-vendored after the API changes have
merged. The following pull request is an example of how to integrate a new ProviderSpec into the
API repository:</p>
<ul>
<li><a href="https://github.com/openshift/api/pull/1045">Machine API: adding Alibaba cloud provider types #1045</a></li>
</ul>
<h3 id="machine-controllers-and-actuators">Machine Controllers and Actuators</h3>
<p>As noted above, the Machine controller manages Machine resources. The Machine controller is also
the interface between the MAO, the Machine API CRDs, and the infrastructure provider. The
controller wraps the <a href="https://github.com/openshift/machine-api-operator/blob/master/pkg/controller/machine/actuator.go">actuator interface</a> which talks directly to the
infrastructure provider. The actuator interface is the contact point between OpenShift's
Machine API and a provider's infrastructure. This diagram illustrates the relationships:</p>
<pre><code class="language-ascii">+----------+              +--------------------+
| Machine  |  reconciles  | Machine controller |
| Resource |&lt;-------------|                    |                +----------------+
+----------+              |    +----------+    |  communicates  |                |
                          |    | actuator |----+---------------&gt;| Infrastructure |
                          |    +----------+    |                |                |
                          +--------------------+                +----------------+
</code></pre>
<p>When writing a new actuator implementation, it is helpful to first start by looking at the
controller wrapper which is provided by the MAO. The controller is defined in the
<a href="https://github.com/openshift/machine-api-operator/blob/master/pkg/controller/machine/controller.go">controller.go</a> file of the <a href="https://github.com/openshift/machine-api-operator">machine-api-operator</a> repository.
This controller is used by each infrastructure provider to associate its actuator code
with the Machine reconciliation. The machine controller is designed to work with
<a href="https://github.com/kubernetes-sigs/controller-runtime">controller-runtime managers</a> using the <code>AddWithActuator</code> method.
For example, here is how the Machine controllers and actuators are configured for AWS and IBM
Cloud:</p>
<ul>
<li><a href="https://github.com/openshift/machine-api-provider-aws/blob/main/cmd/manager/main.go#L161">AWS Machine controller actuator configuration</a></li>
<li><a href="https://github.com/openshift/cluster-api-provider-ibmcloud/blob/main/cmd/manager/main.go#L143">IBM Cloud Machine controller actuator configuration</a></li>
</ul>
<p>The majority of the work when implmenting a Machine controller for a new infrastructure provider
will be satisfying the <a href="https://github.com/openshift/machine-api-operator/blob/master/pkg/controller/machine/actuator.go">actuator interface</a> defined by the MAO. The interface
itself is small enough that it can be reproduced here:</p>
<pre><code class="language-go">type Actuator interface {
    // Create the machine.
    Create(context.Context, *machinev1.Machine) error
    // Delete the machine. If no error is returned, it is assumed that all dependent resources have been cleaned up.
    Delete(context.Context, *machinev1.Machine) error
    // Update the machine to the provided definition.
    Update(context.Context, *machinev1.Machine) error
    // Checks if the machine currently exists.
    Exists(context.Context, *machinev1.Machine) (bool, error)
}
</code></pre>
<p>The following are two examples of Machine actuator implementations:</p>
<ul>
<li><a href="https://github.com/openshift/machine-api-provider-aws/blob/main/pkg/actuators/machine/actuator.go">AWS Machine actuator</a></li>
<li><a href="https://github.com/openshift/cluster-api-provider-ibmcloud/blob/main/pkg/actuators/machine/actuator.go">IBM Cloud Machine actuator</a></li>
</ul>
<h3 id="machineset-controllers">MachineSet Controllers</h3>
<p>Infrastructure provider-specific MachineSet controllers are used to enable scale-from-zero
features with the cluster autoscaler as described in this
<a href="https://github.com/openshift/enhancements/blob/master/enhancements/machine-api/autoscaling-from-to-zero.md">OpenShift enhancement on Autoscaling from/to zero</a>. Unlike the Machine
controller and actuator provided by the MAO, there is no corresponding helpers for
implementing a MachineSet controller.</p>
<p>The following are two examples of MachineSet controllers which implement scale from/to zero:</p>
<ul>
<li><a href="https://github.com/openshift/machine-api-provider-aws/blob/main/pkg/actuators/machineset/controller.go">AWS MachineSet controller</a></li>
<li><a href="https://github.com/openshift/cluster-api-provider-ibmcloud/blob/main/pkg/actuators/machineset/controller.go">IBM Cloud MachineSet controller</a></li>
</ul>
<h3 id="adding-the-new-controllers-to-the-machine-api-operator">Adding the new controllers to the Machine API operator</h3>
<p>With all the necessary controller code and repositories created, the final step for integration
with the Machine API is adding the new infrastructure provider to the Machine API operator.
This process involves adding a manifest for a cloud credential request, adding the container
image references, and updating the operator to detect the new platform.</p>
<p>These changes are best illustrated through example, the following pull request show
the addition of the IBM Cloud provider to the Machine API operator. Take special
note of the <code>CredentialsRequest</code> as this is the resource to encode provider-specific
access roles.</p>
<ul>
<li><a href="https://github.com/openshift/machine-api-operator/pull/871">IBM Cloud provider addition to Machine API operator</a></li>
</ul>
<h2 id="integrating-with-openshift">Integrating with OpenShift</h2>
<p>In addition to implementing the controllers and actuators for a new Machine API provider,
the repository containing this code will need to be included in the OpenShift
organization on GitHub. After adding the new repository to the organization, it will then
need to be configured for continuous integration testing and image creation.</p>
<h3 id="add-machine-api-provider-repo-to-openshift">Add Machine API provider repo to OpenShift</h3>
<p>For the highest levels of integration with OpenShift, it is recommended to copy the
new infrastructure provider code repository to the OpenShift organization on GitHub.
Migrating the code to this organization will help to ensure that the OpenShift continuous
integration processes have full access to the source repository.</p>
<p>To begin adding a new Machine API infrastructure provider repository the first step is
the repository name. It should have a format of <code>machine-api-provider-$PROVIDER_NAME</code>,
where <code>$PROVIDER_NAME</code> is replaced with the infrastructure name. For example, the AWS
provider is <code>machine-api-provider-aws</code>.</p>
<p>The repository will need to be copied into the OpenShift organization.
This process is described in more detail in the
<a href="../procedures/creating-an-openshift-repository">Creating a GitHub Repository in the OpenShift Organization</a>
document.</p>
<p>Having the source code in the OpenShift organization will allow Red Hat's continuous
integration tooling access to it for running tests, building images, and including in
the official releases.</p>
<h3 id="configure-basic-repository-integrations">Configure basic repository integrations</h3>
<p>After setting up the code repository, there are several continuous integration
tasks which must be done. This process is described in more detail in the
<a href="../procedures/configuring-repository-integrations">Configuring Basic Repository Integrations</a>
document.</p>
<p>As an example, here is the pull request to add the MAPI provider for IBM Cloud to the
OpenShift Prow. It configures the Tide mechanics as well as pre-submit jobs to
run the unit tests and check Go language formatting, and post-submit jobs to
build the container images.</p>
<ul>
<li><a href="https://github.com/openshift/release/pull/19890">openshift/release #19890</a></li>
</ul>
<h2 id="relation-to-cluster-api">Relation to Cluster API</h2>
<p>The Machine API shares a common ancestry with the <a href="https://cluster-api.sigs.k8s.io">Cluster API project</a>.
In the early days of Cluster API development, the Machine API was solidified
around the Machine and Machineset object definitions. Over time, the Machine API
has continued to grow in accordance with the needs of OpenShift users. It is worth
noting that the Machine API is <strong>not</strong> API compatible with the current versions of Cluster API.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../network-ingress-dns/" class="btn btn-neutral float-right" title="Network Ingress and DNS">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../container-storage-interface-driver/" class="btn btn-neutral" title="Container Storage Interface Driver"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../container-storage-interface-driver/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../network-ingress-dns/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
